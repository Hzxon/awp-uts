<%- include('../partials/header', {title: 'Laporan Nilai'}) %>

<div class="flex h-screen bg-gray-100">
    <%- include('../partials/sidebar', {user: user, active: 'laporan-nilai'}) %>
    
    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <%- include('../partials/topbar', {user: user, pageTitle: 'Laporan Nilai'}) %>

        <main class="flex-1 p-6 overflow-y-auto">
             <% const dataReports = Array.isArray(reports) ? reports : []; %>
             <div id="print-area" class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-lg font-semibold">Laporan Nilai Siswa</h2>
                    <div class="flex items-center space-x-2 w-full md:w-auto">
                        <form action="/laporan-nilai" method="get" class="mb-4 flex gap-2">
                            <input
                                type="text"
                                name="keyword"
                                value="<%= keyword || '' %>"
                                placeholder="Cari nama / kelas / email / mapel / nilai"
                                class="border border-gray-300 rounded-lg px-3 py-2 w-full"
                            />
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg">Cari</button>
                            <a href="/laporan-nilai" class="px-4 py-2 bg-gray-200 rounded-lg">Reset</a>
                        </form>

                        <button onclick="window.print()" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 whitespace-nowrap">
                            <i data-lucide="printer" class="w-4 h-4 mr-2"></i> Cetak
                        </button>
                    </div>
                </div>
                <!-- Tabel Laporan -->
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">No</th>
                                <th scope="col" class="px-6 py-3">Nama Siswa</th>
                                <th scope="col" class="px-6 py-3">Kelas</th>
                                <th scope="col" class="px-6 py-3">Mata Pelajaran</th>
                                <th scope="col" class="px-6 py-3">Nilai</th>
                                <th scope="col" class="px-6 py-3">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% const badgeClass = (status) => {
                                 const normalized = (status || '').toLowerCase();
                                 if (normalized === 'lulus') return 'text-green-800 bg-green-100';
                                 if (normalized === 'remedial') return 'text-red-800 bg-red-100';
                                 return 'text-gray-700 bg-gray-200';
                               };
                            %>
                            <% if (dataReports.length === 0) { %>
                                <tr>
                                    <td colspan="6" class="text-center py-10 text-gray-500">Data tidak ditemukan.</td>
                                </tr>
                            <% } else { %>
                                <% dataReports.forEach((report, index) => { %>
                                    <% const subjects = report.subjects || []; %>
                                    <% subjects.forEach((subject, subjectIndex) => { %>
                                        <tr class="bg-white border-b">
                                            <% if (subjectIndex === 0) { %>
                                                <td class="px-6 py-4 align-top" rowspan="<%= subjects.length %>"><%= index + 1 %></td>
                                                <td class="px-6 py-4 align-top font-medium text-gray-900" rowspan="<%= subjects.length %>"><%= report.student.name %></td>
                                                <td class="px-6 py-4 align-top" rowspan="<%= subjects.length %>"><%= report.student.class || '-' %></td>
                                            <% } %>
                                            <td class="px-6 py-4"><%= subject.name %></td>
                                            <td class="px-6 py-4"><%= subject.score !== null && subject.score !== undefined ? subject.score : '-' %></td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full <%= badgeClass(subject.status) %>"><%= subject.status %></span>
                                                <% if (subject.note) { %>
                                                    <div class="text-xs text-gray-400 mt-1"><%= subject.note %></div>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% }) %>
                            <% } %>
                        </tbody>
                    </table>
                </div>
             </div>
        </main>
    </div>
</div>

<%- include('../partials/footer') %>
